# Implementation Plan: Monorepo Foundation

**Branch**: `027-monorepo-foundation` | **Date**: 2025-12-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/027-monorepo-foundation/spec.md`

## Summary

Establish a pnpm monorepo foundation with shared Zod schemas and derived TypeScript types package (`@clementine/shared`) that can be imported by both the Next.js web app and Firebase Cloud Functions. Includes deployment infrastructure and a hello world function to verify the setup.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 18+
**Primary Dependencies**: firebase-functions ^5.0.0, firebase-admin ^12.0.0, zod ^4.x, pnpm workspaces
**Storage**: N/A (types-only feature, no Firestore operations)
**Testing**: TypeScript compilation validation, curl endpoint verification
**Target Platform**: Firebase Cloud Functions (Gen 2), Next.js 16 web app
**Project Type**: pnpm monorepo (web + functions + packages/shared)
**Performance Goals**: Function response < 2 seconds, deploy script < 5 minutes
**Constraints**: Must work with existing Firebase project `clementine-7568d`
**Scale/Scope**: 5 shared types, 1 HTTP function, 1 deploy script

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

Verify compliance with Clementine Constitution (`.specify/memory/constitution.md`):

- [x] **Mobile-First Responsive Design**: N/A - backend/build infrastructure only, no user-facing UI
- [x] **Clean Code & Simplicity**: Simple bash script for deployment, no over-engineering
- [x] **Type-Safe Development**: TypeScript strict mode, all types fully defined, no `any`
- [x] **Minimal Testing Strategy**: Manual verification via curl, no unit tests for infrastructure setup
- [x] **Validation Loop Discipline**: Plan includes build verification before deployment
- [x] **Firebase Architecture Standards**: Functions use v2 SDK, Admin SDK available for future use
- [x] **Feature Module Architecture**: N/A - shared package is infrastructure, not a feature module

**Complexity Violations**: None - straightforward monorepo setup following standard patterns.

## Project Structure

### Documentation (this feature)

```text
specs/027-monorepo-foundation/
├── plan.md              # This file
├── research.md          # Research decisions (complete)
├── data-model.md        # Type definitions (complete)
├── quickstart.md        # Setup instructions (complete)
├── contracts/
│   └── hello-world.md   # Hello world endpoint contract
└── tasks.md             # Will be generated by /speckit.tasks
```

### Source Code (repository root)

```text
clementine/
├── packages/
│   └── shared/                    # NEW: Shared Zod schemas package
│       ├── src/
│       │   ├── schemas/
│       │   │   ├── session.schemas.ts # InputAsset, ProcessingState, etc.
│       │   │   └── index.ts           # Re-export schemas and types
│       │   └── index.ts               # Package entry point
│       ├── package.json               # @clementine/shared
│       └── tsconfig.json              # TypeScript config
│
├── functions/                         # UPDATED: Firebase Functions
│   ├── src/
│   │   └── index.ts                   # Hello world function
│   ├── scripts/
│   │   └── deploy.sh                  # Deploy orchestration script
│   ├── lib/                           # Compiled output (gitignored)
│   ├── package.json                   # @clementine/functions
│   └── tsconfig.json                  # TypeScript config
│
├── web/                               # UNCHANGED
│
├── pnpm-workspace.yaml                # UPDATED: Add packages/*
└── firebase.json                      # UPDATED: Add functions config
```

**Structure Decision**: Extend existing monorepo structure. Add `packages/` directory for shared packages (starting with `shared`). Deploy script lives in `functions/scripts/` since it's specific to functions deployment.

## Implementation Approach

### Phase 1: Shared Package Setup

1. Create `packages/shared/` directory structure
2. Define Zod schemas in `src/schemas/session.schemas.ts`
3. Export schemas and derived types via barrel exports
4. Configure `package.json` with Zod dependency and dual ESM/CJS output
5. Configure `tsconfig.json` with strict mode
6. Update `pnpm-workspace.yaml` to include `packages/*`

### Phase 2: Functions Package Setup

1. Create `functions/src/index.ts` with hello world function
2. Create `functions/package.json` with dependencies
3. Create `functions/tsconfig.json` for Node.js target
4. Import and use `@clementine/shared` schemas and types

### Phase 3: Deployment Infrastructure

1. Update `firebase.json` with functions configuration
2. Create `functions/scripts/deploy.sh` with fail-fast behavior
3. Add functions emulator to emulators config

### Phase 4: Verification

1. Run `pnpm install` to verify workspace resolution
2. Build shared package and verify output
3. Build functions and verify shared type imports
4. Test locally with emulator
5. Deploy and verify production endpoint

## Key Technical Decisions

| Decision | Choice | Reference |
|----------|--------|-----------|
| Workspace tool | pnpm workspaces | research.md |
| Schema library | Zod (schemas + derived types) | data-model.md |
| Shared package format | Dual ESM + CJS | research.md |
| Functions SDK version | Firebase v2 | research.md |
| Build orchestration | Bash script in functions/ | User decision |
| TypeScript version | 5.x (match web) | Existing config |

## Dependencies

### New Production Dependencies

**@clementine/shared**:
- `zod`: ^4.0.0 (match web version)

**@clementine/functions**:
- `firebase-admin`: ^12.0.0
- `firebase-functions`: ^5.0.0
- `@clementine/shared`: workspace:*

### New Development Dependencies

**@clementine/shared**:
- `typescript`: ^5.0.0

**@clementine/functions**:
- `typescript`: ^5.0.0

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| TypeScript version mismatch | Pin same version across workspaces |
| Firebase deploy fails | Script uses `set -e`, logs each step |
| Shared package not rebuilt | Deploy script always rebuilds shared first |
| pnpm workspace resolution | Verify with `pnpm install` after setup |
| Zod version mismatch | Use same Zod version as web (^4.0.0) |

## Artifacts Generated

- [x] `research.md` - Technical decisions
- [x] `data-model.md` - Type definitions
- [x] `contracts/hello-world.md` - API contract
- [x] `quickstart.md` - Setup instructions
- [ ] `tasks.md` - To be generated by `/speckit.tasks`
