# Research: Dropbox Video Export & Email Video Handling

**Feature Branch**: `079-dropbox-email-video`
**Date**: 2026-02-23

---

## R1: Dropbox Chunked Upload for Large Video Files

### Decision
Use Dropbox Upload Session API (HTTP, no SDK) for files exceeding 150MB. Files under 150MB continue using the existing single-request upload.

### Rationale
- Current `uploadFile()` in `dropbox.service.ts` uses the single `/2/files/upload` endpoint, which has a 150MB limit per request
- Video files can be up to 500MB per the spec (FR-001)
- Dropbox Upload Sessions split large files into chunks: `upload_session/start` → `upload_session/append_v2` (repeated) → `upload_session/finish`
- This is already HTTP-based (consistent with existing pattern — no SDK)

### Alternatives Considered
1. **Dropbox SDK**: Rejected — the 069-dropbox-export explicitly chose HTTP-only to avoid SDK dependency bloat
2. **Single upload with increased timeout**: Not possible — Dropbox enforces 150MB hard limit on `/2/files/upload`
3. **Compress video before upload**: Rejected — would degrade quality and add processing time

### Implementation Details
- **Chunk size**: 8MB (within Dropbox recommended range, balances memory usage and request count)
- **Threshold**: Files > 150MB use chunked upload; ≤ 150MB use existing single upload
- **Progress tracking**: Log after each chunk append (FR-004)
- **Idempotency**: Upload sessions are inherently idempotent if re-started from scratch (new session ID per attempt)
- **Memory**: Stream chunks rather than loading entire file — Cloud Function has 512MB memory limit

---

## R2: File Naming Convention for Video Exports

### Decision
Keep the existing naming pattern from 069-dropbox-export: `{date}_{time}_session-{shortCode}_result.{ext}`

### Rationale
- The existing pattern includes session traceability (short code maps back to session ID)
- The PRD suggested `eventName_userId_timestamp.mp4` but the 069-dropbox-export implementation already established a working convention
- Changing naming mid-feature would break consistency with existing image exports
- The extension naturally becomes `.mp4` for video files (extracted from source file path)

### Alternatives Considered
1. **PRD naming format**: `eventName_userId_timestamp.mp4` — rejected because it would be inconsistent with existing image exports and the event name may contain special characters requiring sanitization
2. **New unified format**: Rejected — unnecessary churn for existing working exports

---

## R3: Email Template Branching by Media Type

### Decision
Extend the email payload schema to include `format` and `thumbnailUrl`, then branch the HTML template based on `format`.

### Rationale
- Current `sendSessionEmailPayloadSchema` has no `format` field — it only passes `url`, `filePath`, `displayName`
- The `JobOutput` schema already tracks `format: 'image' | 'gif' | 'video'` and `thumbnailUrl`
- The email template currently hardcodes "Here's your AI-generated photo" — must be made dynamic
- For video: display thumbnail image + "Watch Your Video" CTA linking to result page
- For image/gif: embed directly (existing behavior, with dynamic copy)

### Alternatives Considered
1. **Separate email templates per media type**: Rejected — would duplicate 90% of shared layout HTML. A single template with conditional sections is simpler
2. **Send video as attachment**: Rejected — email attachment size limits (typically 25MB) and client compatibility issues make this unreliable
3. **Generate animated GIF preview for video emails**: Rejected — adds complexity, most email clients limit GIF size, thumbnail + CTA is the industry standard approach

### Implementation Details
- **Schema change**: Add `format: z.enum(['image', 'gif', 'video'])` and `thumbnailUrl: z.string().optional()` to `sendSessionEmailPayloadSchema`
- **Template function**: Accept format parameter, return different HTML blocks for video vs image
- **CTA link**: For video, link to `/join/{projectId}/share?session={sessionId}` (existing result page)
- **Thumbnail source**: `JobOutput.thumbnailUrl` — already generated by the pipeline in `aiVideoOutcome.ts`

---

## R4: Video Thumbnail Availability

### Decision
Reuse the existing `thumbnailUrl` from `JobOutput` — no additional thumbnail generation needed for email.

### Rationale
- The AI video pipeline (`aiVideoOutcome.ts`) already calls `generateThumbnail()` via FFmpeg and stores the result as `thumbnailUrl` on the job output
- This thumbnail is a 300px-wide JPG extracted from the first frame of the video
- The thumbnail URL is a public Firebase Storage URL — can be directly embedded in email HTML
- For the fallback case (FR-012), use a static placeholder image hosted in Firebase Storage

### Alternatives Considered
1. **Generate a separate email-specific thumbnail**: Rejected — unnecessary duplication; existing thumbnail is suitable for email
2. **Use video poster frame from a different timestamp**: Rejected — adds complexity for marginal visual improvement

---

## R5: Retry and Error Handling for Video Uploads

### Decision
Leverage existing Cloud Task retry infrastructure with enhanced error categorization for video-specific failures.

### Rationale
- The `exportDropboxTask` already has 3 retries with 30-300s exponential backoff
- Error categorization (auth errors vs transient vs quota) is already implemented
- For video, the same categories apply — no new error types needed
- The only addition is file size validation before upload (FR-008, FR-013) — reject files > 500MB upfront

### Implementation Details
- **Pre-upload validation**: Check `sizeBytes` from job output before download/upload attempt
- **Size limit**: 500MB (524,288,000 bytes)
- **Chunked upload failure**: If a chunk fails mid-upload, the entire session is abandoned and the Cloud Task retry starts a fresh upload session
- **Rate limit handling**: Existing pattern (re-throw to trigger Cloud Task retry with backoff) applies to chunked upload API calls as well

---

## R6: Result Page Video Playback

### Decision
The existing SharePage/ShareReadyRenderer already displays results. Video playback support needs verification but is assumed to be handled by the existing `resultMediaUrl` rendering.

### Rationale
- `ShareReadyRenderer` receives `mediaUrl` and renders it
- If the component already handles video URLs (renders `<video>` tag for `.mp4`), no changes needed
- If not, a minor update to detect video URLs and render an HTML5 video player is needed
- The result page route (`/join/$projectId/share?session={mainSessionId}`) is already the CTA destination

### Implementation Details
- Verify ShareReadyRenderer handles video MIME types
- If not, add conditional rendering: `<video>` tag for video URLs, `<img>` for image URLs
- Include video controls (play, pause, fullscreen) and autoplay with muted attribute for better UX

---

## R7: Export Task Payload for Video

### Decision
Extend the existing `DropboxExportPayload` to include `sizeBytes` for pre-upload validation.

### Rationale
- The current payload includes file reference info but not file size
- Adding `sizeBytes` allows the export task to reject oversized files before downloading them (FR-013)
- This avoids wasting bandwidth and Cloud Function execution time on files that will be rejected

### Alternatives Considered
1. **Check size after download**: Rejected — wastes bandwidth downloading a 500MB+ file only to reject it
2. **Check size at dispatch time**: Better — dispatch task can filter before enqueuing export task. But the export task should also validate as a defense-in-depth measure
