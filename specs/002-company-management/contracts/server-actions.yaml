# Server Actions API Contract: Company Management

# Overview
# This document defines the API contract for Company Management Server Actions
# All actions use Next.js Server Actions pattern ("use server")
# Authentication: ADMIN_SECRET cookie/header (verified server-side)
# Error handling: Return { success: false, error: string } on failure

# ============================================================================
# Company Actions (actions/companies.ts)
# ============================================================================

createCompanyAction:
  description: Create a new company with unique name validation
  input:
    type: object
    required: [name]
    properties:
      name:
        type: string
        minLength: 1
        maxLength: 100
        description: Company display name (must be unique among active companies)
      brandColor:
        type: string
        pattern: ^#[0-9A-F]{6}$
        description: Optional hex color for branding
      contactEmail:
        type: string
        format: email
        description: Optional contact email
      termsUrl:
        type: string
        format: uri
        description: Optional terms of service URL
      privacyUrl:
        type: string
        format: uri
        description: Optional privacy policy URL
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          companyId:
            type: string
            description: ID of created company
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
            description: Error message (e.g., "Company name already exists")
  validation:
    - Transaction-based uniqueness check for name (case-insensitive)
    - Zod schema validation for all fields
    - ADMIN_SECRET authentication required
  sideEffects:
    - Creates new document in companies/ collection
    - Revalidates /companies path

updateCompanyAction:
  description: Update company name (and optional metadata)
  input:
    type: object
    required: [companyId, name]
    properties:
      companyId:
        type: string
        description: ID of company to update
      name:
        type: string
        minLength: 1
        maxLength: 100
        description: New company name (must be unique excluding self)
      brandColor:
        type: string
        pattern: ^#[0-9A-F]{6}$
        description: Optional hex color
      contactEmail:
        type: string
        format: email
        description: Optional contact email
      termsUrl:
        type: string
        format: uri
        description: Optional terms URL
      privacyUrl:
        type: string
        format: uri
        description: Optional privacy URL
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
            description: Error message
  validation:
    - Transaction-based uniqueness check (exclude self from duplicate check)
    - Company must exist and be active
    - ADMIN_SECRET authentication required
  sideEffects:
    - Updates company document
    - Revalidates /companies and /companies/[companyId] paths
    - Company name change propagates to all events (via join at display time)

deleteCompanyAction:
  description: Soft delete a company (mark as deleted, do not remove)
  input:
    type: object
    required: [companyId]
    properties:
      companyId:
        type: string
        description: ID of company to delete
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
            description: Error message
  validation:
    - Company must exist
    - ADMIN_SECRET authentication required
  sideEffects:
    - Sets status="deleted", deletedAt=timestamp
    - Does NOT delete associated events (events remain with companyId)
    - Revalidates /companies path
    - Guest links for company's events become inaccessible

listCompaniesAction:
  description: List all active companies (exclude deleted)
  input: null
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          companies:
            type: array
            items:
              type: object
              properties:
                id: string
                name: string
                status: { enum: [active, deleted] }
                deletedAt: { type: [number, null] }
                brandColor: { type: string, optional: true }
                contactEmail: { type: string, optional: true }
                termsUrl: { type: string, optional: true }
                privacyUrl: { type: string, optional: true }
                createdAt: number
                updatedAt: number
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
  validation:
    - ADMIN_SECRET authentication required
  query:
    - Filter: status == "active"
    - Order: name ASC
  notes:
    - Returns empty array if no companies exist
    - Deleted companies never returned

getCompanyAction:
  description: Get single company by ID
  input:
    type: object
    required: [companyId]
    properties:
      companyId:
        type: string
        description: Company ID
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          company:
            type: object
            description: Company document (same schema as listCompaniesAction)
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
            description: "Company not found" or other error
  validation:
    - ADMIN_SECRET authentication required
  notes:
    - Returns error if company is deleted or does not exist

getCompanyEventCountAction:
  description: Count events for a company
  input:
    type: object
    required: [companyId]
    properties:
      companyId:
        type: string
        description: Company ID
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          eventCount:
            type: number
            description: Number of events (all statuses)
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
  validation:
    - ADMIN_SECRET authentication required
  query:
    - Firestore count() query on events collection
    - Filter: companyId == companyId
  performance:
    - Uses count() aggregation (no document reads)

# ============================================================================
# Event Actions (actions/events.ts - EXTENDED)
# ============================================================================

createEventAction:
  description: Create event (extended with companyId)
  input:
    type: object
    required: [title, brandColor, showTitleOverlay]
    properties:
      title:
        type: string
        minLength: 1
        maxLength: 100
      brandColor:
        type: string
        pattern: ^#[0-9A-F]{6}$
      showTitleOverlay:
        type: boolean
      companyId:
        type: [string, null]
        description: NEW - Optional company reference
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          eventId:
            type: string
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
  validation:
    - If companyId provided, must reference existing active company
    - All existing event validations apply
  sideEffects:
    - Creates event with companyId field
    - Revalidates /events path

updateEventAction:
  description: Update event (NEW - allows changing companyId)
  input:
    type: object
    required: [eventId]
    properties:
      eventId:
        type: string
      companyId:
        type: [string, null]
        description: NEW - Change company association (null = remove)
      # Other event fields (title, brandColor, etc.) as needed
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
  validation:
    - If companyId provided, must reference existing active company
    - Event must exist
  sideEffects:
    - Updates event.companyId
    - Revalidates /events and /events/[eventId] paths

listEventsAction:
  description: List events (extended with company filtering)
  input:
    type: object
    properties:
      filters:
        type: object
        properties:
          companyId:
            type: [string, null]
            description: Filter by company (null = no company)
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          events:
            type: array
            items:
              type: object
              description: Event document (includes companyId field)
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
  validation:
    - ADMIN_SECRET authentication required
  query:
    - If filters.companyId provided: .where('companyId', '==', companyId)
    - If filters.companyId === null: .where('companyId', '==', null)
    - If no filters: return all events
    - Order: createdAt DESC
  notes:
    - Company name NOT included in event documents (joined separately for display)

# ============================================================================
# Guest Link Validation (join/[eventId]/page.tsx - EXTENDED)
# ============================================================================

validateGuestLinkAction:
  description: Server-side validation for /join/[eventId] page load
  input:
    type: object
    required: [eventId]
    properties:
      eventId:
        type: string
  output:
    oneOf:
      - type: object
        properties:
          success:
            type: boolean
            const: true
          event:
            type: object
            description: Event document
          company:
            type: [object, null]
            description: Company document (if event has companyId)
      - type: object
        properties:
          success:
            type: boolean
            const: false
          error:
            type: string
            enum: ["Event not found", "Event unavailable", "Company deleted"]
  validation:
    - Event must exist
    - If event.companyId, check company.status != "deleted"
  performance:
    - Cache company.status in-memory (60s TTL) to reduce reads
  errorHandling:
    - Event not found: Return 404
    - Company deleted: Return custom error page "Event Unavailable"

# ============================================================================
# Error Handling Patterns
# ============================================================================

errorResponse:
  pattern: "{ success: false, error: string }"
  examples:
    validation:
      error: "Company name is required"
      error: "Invalid hex color"
      error: "Company name already exists"
    notFound:
      error: "Company not found"
      error: "Event not found"
    authorization:
      error: "Authentication required"
      error: "Invalid admin secret"
    business:
      error: "Cannot delete company with events" # Future enhancement
      error: "Company name already exists"

# ============================================================================
# Authentication
# ============================================================================

authentication:
  method: ADMIN_SECRET cookie/header
  enforcement: Server-side validation in each Server Action
  pattern: |
    "use server"
    import { cookies } from "next/headers"

    export async function myAction() {
      const adminSecret = cookies().get("ADMIN_SECRET")?.value
      if (adminSecret !== process.env.ADMIN_SECRET) {
        return { success: false, error: "Authentication required" }
      }
      // ... rest of action
    }

# ============================================================================
# Revalidation Strategy
# ============================================================================

revalidation:
  pattern: next/cache revalidatePath
  rules:
    - createCompanyAction: revalidatePath("/companies")
    - updateCompanyAction: revalidatePath("/companies"), revalidatePath("/companies/[id]")
    - deleteCompanyAction: revalidatePath("/companies")
    - createEventAction: revalidatePath("/events")
    - updateEventAction: revalidatePath("/events"), revalidatePath("/events/[id]")
  notes:
    - Ensures UI reflects latest data after mutations
    - Next.js App Router auto-rerenders affected pages
