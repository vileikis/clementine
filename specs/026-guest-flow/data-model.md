# Data Model: Guest Flow

**Feature**: 026-guest-flow
**Date**: 2024-12-11

## Overview

This document defines the data entities introduced by the guest flow feature. These entities are stored in Firestore as subcollections under projects.

---

## Entity: Guest

Represents an anonymous visitor to a project. Created when a guest first authenticates on the welcome screen.

### Firestore Path

```
/projects/{projectId}/guests/{guestId}
```

**Note**: `guestId` is the Firebase Auth anonymous user UID.

### Schema

```typescript
interface Guest {
  /** Firebase Auth anonymous user UID (also the document ID) */
  id: string

  /** Reference to the project this guest visited */
  projectId: string

  /** Firebase Auth UID (same as id, for querying) */
  authUid: string

  /** Timestamp when guest first visited (ms since epoch) */
  createdAt: number

  /** Last activity timestamp (updated on session creation) */
  lastSeenAt: number
}
```

### Zod Schema

```typescript
import { z } from "zod"

export const guestSchema = z.object({
  id: z.string().min(1),
  projectId: z.string().min(1),
  authUid: z.string().min(1),
  createdAt: z.number().int().positive(),
  lastSeenAt: z.number().int().positive(),
})

export type Guest = z.infer<typeof guestSchema>

export const createGuestSchema = guestSchema.omit({ id: true })
export type CreateGuestInput = z.infer<typeof createGuestSchema>
```

### Validation Rules

| Field | Constraint |
|-------|------------|
| id | Non-empty string, matches Firebase Auth UID format |
| projectId | Must reference existing project |
| authUid | Must match authenticated user |
| createdAt | Unix timestamp in milliseconds |
| lastSeenAt | >= createdAt |

### State Transitions

Guests have no lifecycle states - they are created once and updated on activity.

---

## Entity: Session

Represents a single guest interaction with an experience. Created when a guest taps an experience to start it.

### Firestore Path

```
/projects/{projectId}/sessions/{sessionId}
```

**Note**: `sessionId` is auto-generated by Firestore.

### Schema

```typescript
interface Session {
  /** Firestore auto-generated document ID */
  id: string

  /** Reference to the project */
  projectId: string

  /** Reference to the guest who started this session */
  guestId: string

  /** Reference to the experience being run */
  experienceId: string

  /** Reference to the active event at session creation */
  eventId: string

  /** Session lifecycle state */
  state: SessionState

  /** Current step index in experience flow (for future use) */
  currentStepIndex: number

  /** Collected input data keyed by step ID (for future use) */
  data: Record<string, unknown>

  /** Timestamp when session was created */
  createdAt: number

  /** Timestamp when session was last updated */
  updatedAt: number
}

type SessionState =
  | "created"      // Initial state after creation
  | "in_progress"  // Guest is actively interacting
  | "completed"    // Guest finished the experience
  | "abandoned"    // Session timed out or guest left
  | "error"        // Something went wrong
```

### Zod Schema

```typescript
import { z } from "zod"

export const sessionStateSchema = z.enum([
  "created",
  "in_progress",
  "completed",
  "abandoned",
  "error",
])

export type SessionState = z.infer<typeof sessionStateSchema>

export const sessionSchema = z.object({
  id: z.string().min(1),
  projectId: z.string().min(1),
  guestId: z.string().min(1),
  experienceId: z.string().min(1),
  eventId: z.string().min(1),
  state: sessionStateSchema,
  currentStepIndex: z.number().int().min(0),
  data: z.record(z.string(), z.unknown()),
  createdAt: z.number().int().positive(),
  updatedAt: z.number().int().positive(),
})

export type Session = z.infer<typeof sessionSchema>

export const createSessionSchema = z.object({
  projectId: z.string().min(1),
  guestId: z.string().min(1),
  experienceId: z.string().min(1),
  eventId: z.string().min(1),
})

export type CreateSessionInput = z.infer<typeof createSessionSchema>
```

### Validation Rules

| Field | Constraint |
|-------|------------|
| id | Non-empty string, Firestore auto-generated |
| projectId | Must reference existing project |
| guestId | Must reference existing guest in same project |
| experienceId | Must be valid experience ID from event |
| eventId | Must reference active event in project |
| state | One of defined SessionState values |
| currentStepIndex | Non-negative integer |
| data | JSON object (empty initially) |
| createdAt | Unix timestamp in milliseconds |
| updatedAt | >= createdAt |

### State Transitions

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   created ──────► in_progress ──────► completed             │
│      │                │                                     │
│      │                │                                     │
│      ▼                ▼                                     │
│   abandoned        error                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| From | To | Trigger |
|------|----|---------|
| created | in_progress | Guest begins first step |
| created | abandoned | Session timeout (future) |
| in_progress | completed | Guest finishes last step |
| in_progress | abandoned | Guest leaves, timeout |
| in_progress | error | Step execution fails |

**Note**: For MVP, sessions remain in "created" state (experience engine not implemented).

---

## Relationships

```
Project (1) ──────────────── (*) Guest
    │                            │
    │                            │
    └──────── (*) Session ◄──────┘
                   │
                   │
              Experience (from /experiences collection)
```

### Foreign Keys

| Entity | Field | References |
|--------|-------|------------|
| Guest | projectId | `/projects/{projectId}` |
| Session | projectId | `/projects/{projectId}` |
| Session | guestId | `/projects/{projectId}/guests/{guestId}` |
| Session | experienceId | `/experiences/{experienceId}` |
| Session | eventId | `/projects/{projectId}/events/{eventId}` |

---

## Indexes

### Required Composite Indexes

```
Collection: projects/{projectId}/sessions
Index: guestId ASC, createdAt DESC
Purpose: Query sessions by guest, ordered by recency

Collection: projects/{projectId}/sessions
Index: experienceId ASC, state ASC
Purpose: Analytics - sessions by experience and state

Collection: projects/{projectId}/guests
Index: lastSeenAt DESC
Purpose: Find recently active guests
```

### Auto-Created Single-Field Indexes

Firestore automatically indexes all fields. No additional configuration needed.

---

## Migration Notes

### From Existing Sessions Module

The existing `features/sessions/` module stores sessions at `/events/{eventId}/sessions/`. The new guest flow stores sessions at `/projects/{projectId}/sessions/`.

**Coexistence Strategy**:
- New guest flow uses project-scoped sessions (this spec)
- Legacy session code remains unchanged
- No migration needed - new collection, new code path

### Future Considerations

1. **Session cleanup**: Implement TTL or scheduled function to delete abandoned sessions
2. **Guest merging**: If guest clears cookies and returns, consider linking by device fingerprint (future)
3. **Analytics aggregation**: May want to denormalize session counts on guest record
