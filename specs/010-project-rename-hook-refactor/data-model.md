# Data Model: Project Rename & Hook Refactor

**Feature**: 010-project-rename-hook-refactor
**Date**: 2026-01-03

## Overview

This feature adds rename capability to the existing `Project` entity and refactors the `useCreateProject` hook. No new entities are introduced - only new operations on the existing `Project` entity and new input/output types for type safety.

---

## Entity: Project

**Collection**: `projects`
**Status**: ✅ **EXISTING** (No schema changes to Firestore document)

### Firestore Document Structure

```typescript
{
  id: string                    // Auto-generated Firestore document ID
  name: string                  // Project name (1-100 chars, UPDATABLE via rename)
  workspaceId: string           // Reference to parent workspace
  status: 'draft' | 'live' | 'deleted'  // Project lifecycle status
  activeEventId: string | null  // Currently active event (nullable)
  deletedAt: number | null      // Soft delete timestamp (nullable)
  createdAt: number             // Server timestamp (milliseconds since epoch)
  updatedAt: number             // Server timestamp (UPDATED on rename)
}
```

### Field Constraints

| Field | Type | Required | Constraints | Updatable |
|-------|------|----------|-------------|-----------|
| `id` | string | Yes | Auto-generated by Firestore | No |
| `name` | string | Yes | 1-100 chars, non-empty | **Yes** (via rename) |
| `workspaceId` | string | Yes | Valid workspace ID | No |
| `status` | enum | Yes | 'draft' \| 'live' \| 'deleted' | Yes (via activate/delete) |
| `activeEventId` | string \| null | No | Valid event ID or null | Yes (via activate) |
| `deletedAt` | number \| null | No | Timestamp or null | Yes (via delete) |
| `createdAt` | number | Yes | Server timestamp | No |
| `updatedAt` | number | Yes | Server timestamp | **Yes** (auto-updated) |

### Indexes

**Existing Indexes** (defined in `firestore.indexes.json`):
```json
{
  "collectionGroup": "projects",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "workspaceId", "order": "ASCENDING" },
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

**Used by**:
```typescript
query(
  projectsRef,
  where('workspaceId', '==', workspaceId),
  where('status', '!=', 'deleted'),
  orderBy('status'),
  orderBy('createdAt', 'desc')
)
```

**No new indexes required** - Rename operation doesn't change query patterns.

---

## Operations

### 1. Rename Project (NEW)

**Operation Type**: UPDATE
**Mutation**: `useRenameProject`
**Firestore Method**: `runTransaction` + `transaction.update()`

**Input**:
```typescript
interface RenameProjectInput {
  projectId: string  // ID of project to rename
  name: string       // New name (validated: 1-100 chars)
}
```

**Validation Schema**:
```typescript
const updateProjectInputSchema = z.object({
  name: z
    .string()
    .min(1, 'Project name is required')
    .max(100, 'Project name too long'),
})
```

**Transaction Steps**:
1. Get document reference: `doc(firestore, 'projects', projectId)`
2. Read document in transaction: `transaction.get(ref)`
3. Verify document exists (throw if not)
4. Update fields:
   ```typescript
   transaction.update(ref, {
     name: validatedName,
     updatedAt: serverTimestamp(),
   })
   ```

**Return Value**:
```typescript
{
  projectId: string
  name: string
}
```

**Side Effects**:
- Updates `updatedAt` timestamp (automatic)
- Triggers `onSnapshot` listener in `useProjects`
- Invalidates `['projects', workspaceId]` query cache

**Error Cases**:
- Project not found → `Error: 'Project not found'`
- Invalid name (Zod validation) → `ZodError` with field errors
- Permission denied → Firestore security rule error
- Network failure → Firebase network error

---

### 2. Create Project (REFACTORED)

**Operation Type**: CREATE
**Mutation**: `useCreateProject`
**Firestore Method**: `runTransaction` + `transaction.set()`

**Changes**:
- ❌ **REMOVE**: Navigation side effect in `onSuccess`
- ✅ **KEEP**: Query invalidation in `onSuccess`
- ✅ **KEEP**: Return value structure (consumer needs for navigation)

**Input** (unchanged):
```typescript
interface CreateProjectInput {
  workspaceId: string
  workspaceSlug: string  // Needed for navigation (handled by consumer)
  name?: string          // Optional, defaults to generated name
}
```

**Return Value** (unchanged):
```typescript
{
  projectId: string
  workspaceId: string
  workspaceSlug: string  // Consumer uses this for navigation
}
```

**Refactoring Changes**:

**BEFORE**:
```typescript
onSuccess: ({ projectId, workspaceId, workspaceSlug }) => {
  queryClient.invalidateQueries({ queryKey: ['projects', workspaceId] })

  // ❌ Navigation side effect (REMOVE)
  navigate({
    to: '/workspace/$workspaceSlug/projects/$projectId',
    params: { workspaceSlug, projectId },
  })
}
```

**AFTER**:
```typescript
onSuccess: ({ workspaceId }) => {
  queryClient.invalidateQueries({ queryKey: ['projects', workspaceId] })
  // No navigation - consumer handles this using return value
}
```

**Consumer Changes** (ProjectsPage.tsx):

**BEFORE**:
```typescript
const handleCreateProject = () => {
  createProject.mutate({
    workspaceId,
    workspaceSlug,
    name: 'New Project',
  })
  // Navigation happens in hook
}
```

**AFTER**:
```typescript
const handleCreateProject = async () => {
  try {
    const result = await createProject.mutateAsync({
      workspaceId,
      workspaceSlug,
      name: 'New Project',
    })

    // Consumer handles navigation
    navigate({
      to: '/workspace/$workspaceSlug/projects/$projectId',
      params: {
        workspaceSlug: result.workspaceSlug,
        projectId: result.projectId,
      },
    })

    toast.success('Project created')
  } catch (error) {
    toast.error('Failed to create project')
  }
}
```

---

## Type System

### New Types (to be added to `project.types.ts`)

```typescript
/**
 * Input type for renaming a project
 * Used by useRenameProject hook and RenameProjectDialog component
 */
export interface RenameProjectInput {
  projectId: string
  name: string
}

/**
 * Input type for updating project fields
 * Used for Zod validation in rename mutation
 */
export interface UpdateProjectInput {
  name: string
}
```

### Existing Types (unchanged)

```typescript
export type ProjectStatus = 'draft' | 'live' | 'deleted'

export interface Project {
  id: string
  name: string
  workspaceId: string
  status: ProjectStatus
  activeEventId: string | null
  deletedAt: number | null
  createdAt: number
  updatedAt: number
}

export interface CreateProjectInput {
  workspaceId: string
  workspaceSlug: string
  name?: string
}

export interface DeleteProjectInput {
  id: string
}
```

---

## Validation Schemas

### New Schema (to be added to `project.schemas.ts`)

```typescript
/**
 * Validates project update input (rename operation)
 * Used by: useRenameProject mutation hook
 */
export const updateProjectInputSchema = z.object({
  name: z
    .string()
    .min(1, 'Project name is required')
    .max(100, 'Project name too long'),
})

export type UpdateProjectInput = z.infer<typeof updateProjectInputSchema>
```

### Existing Schemas (unchanged)

```typescript
export const projectSchema = z.object({
  id: z.string().min(1),
  name: z.string().min(1).max(100),
  workspaceId: z.string().min(1),
  status: z.enum(['draft', 'live', 'deleted']),
  activeEventId: z.string().nullable(),
  deletedAt: z.number().int().positive().nullable(),
  createdAt: z.number().int().positive(),
  updatedAt: z.number().int().positive(),
})

export const createProjectInputSchema = z.object({
  workspaceId: z.string().min(1),
  name: z.string().min(1).max(100).optional(),
})

export const deleteProjectInputSchema = z.object({
  id: z.string().min(1),
})
```

---

## State Management

### TanStack Query Cache

**Query Key**: `['projects', workspaceId]`

**Invalidation Triggers**:
- Create project → Invalidate `['projects', workspaceId]`
- Rename project → Invalidate `['projects', workspaceId]`
- Delete project → Invalidate `['projects', workspaceId]`
- Activate event → No invalidation (doesn't affect projects list)

**Real-time Updates**:
- `useProjects` hook sets up `onSnapshot` listener
- Listener updates query cache directly via `queryClient.setQueryData`
- Mutations trigger Firestore updates → onSnapshot fires → cache updates → UI re-renders

**Cache Flow**:
```
User clicks "Rename"
  ↓
Dialog calls renameProject.mutateAsync()
  ↓
Mutation updates Firestore
  ↓
onSuccess invalidates ['projects', workspaceId]
  ↓
onSnapshot listener fires (Firestore real-time)
  ↓
Listener calls queryClient.setQueryData()
  ↓
UI re-renders with new name
```

---

## Relationships

### Project → Workspace (Many-to-One)

```typescript
// Project belongs to one workspace
project.workspaceId → workspace.id

// Query pattern
query(
  collection(firestore, 'projects'),
  where('workspaceId', '==', workspaceId)
)
```

### Project → ProjectEvent (One-to-Many)

```typescript
// Project has many events
projectEvent.projectId → project.id

// Active event reference
project.activeEventId → projectEvent.id (nullable)
```

---

## Security Rules

**Firestore Security Rules** (existing, no changes needed):

```javascript
match /projects/{projectId} {
  // Read: Any authenticated user in the workspace
  allow read: if isAuthenticated() &&
                 isWorkspaceMember(resource.data.workspaceId);

  // Create: Workspace admin only
  allow create: if isAuthenticated() &&
                   isWorkspaceAdmin(request.resource.data.workspaceId);

  // Update: Workspace admin only (covers rename operation)
  allow update: if isAuthenticated() &&
                   isWorkspaceAdmin(resource.data.workspaceId);

  // Delete: Workspace admin only
  allow delete: if isAuthenticated() &&
                   isWorkspaceAdmin(resource.data.workspaceId);
}
```

**Rename Operation Authorization**:
- User must be authenticated
- User must be workspace admin for the project's workspace
- Enforced by `isWorkspaceAdmin(resource.data.workspaceId)` check
- No additional security rules needed

---

## Migration Notes

**Database Migration**: ❌ **NOT REQUIRED**

This feature:
- ✅ Uses existing `Project` entity structure
- ✅ No new fields added to Firestore documents
- ✅ No data backfill needed
- ✅ No index changes required
- ✅ Security rules already support update operation

**Deployment Safety**:
- Frontend and backend changes are independent
- No breaking changes to existing APIs
- Real-time listeners continue working unchanged
- Rollback safe (no irreversible data changes)

---

## Testing Data Model

### Test Cases for Rename Operation

| Test Case | Input | Expected Outcome |
|-----------|-------|------------------|
| Valid rename | `{ projectId: 'abc', name: 'New Name' }` | Success, name updated, `updatedAt` updated |
| Empty name | `{ projectId: 'abc', name: '' }` | Zod validation error: 'Project name is required' |
| Name too long | `{ projectId: 'abc', name: 'a'.repeat(101) }` | Zod validation error: 'Project name too long' |
| Non-existent project | `{ projectId: 'invalid', name: 'New Name' }` | Error: 'Project not found' |
| Unauthorized user | `{ projectId: 'abc', name: 'New Name' }` (non-admin) | Firestore permission denied error |
| Network failure | `{ projectId: 'abc', name: 'New Name' }` (offline) | Firebase network error |

### Test Cases for Create Refactor

| Test Case | Expected Behavior |
|-----------|-------------------|
| Create project | Hook returns `{ projectId, workspaceId, workspaceSlug }` |
| Navigation handling | Consumer handles navigation (not hook) |
| Query invalidation | `['projects', workspaceId]` query invalidated |
| Error handling | Consumer shows toast (not hook) |

---

## Summary

**New Operations**:
- ✅ Rename project (`useRenameProject` hook)

**Refactored Operations**:
- ✅ Create project (remove navigation side effect)

**Data Model Changes**:
- ❌ No Firestore schema changes
- ✅ New TypeScript types: `RenameProjectInput`, `UpdateProjectInput`
- ✅ New Zod schema: `updateProjectInputSchema`

**Migration Required**: ❌ No

**Breaking Changes**: ❌ None (internal refactor only)
