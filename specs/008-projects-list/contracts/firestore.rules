// Firestore Security Rules: Projects Collection
// Feature: 008-projects-list
//
// These rules should be added to the main firestore.rules file in the firebase/ directory.
// Add the projects match block after the workspaces rules.

match /projects/{projectId} {
  // Helper: Check if user is admin (reuse existing isAdmin function from main rules)
  // function isAdmin() {
  //   return request.auth != null && request.auth.token.admin == true;
  // }

  // Helper: Check if user is admin of the project's workspace
  // This ensures workspace-scoped access control
  function isWorkspaceAdmin(workspaceId) {
    return isAdmin()
      && exists(/databases/$(database)/documents/workspaces/$(workspaceId))
      && get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.status == 'active';
  }

  // Helper: Validate project data structure on create
  function isValidCreateData() {
    let data = request.resource.data;
    return data.keys().hasAll(['name', 'workspaceId', 'status', 'activeEventId', 'deletedAt', 'createdAt', 'updatedAt'])
      && data.name is string
      && data.name.size() >= 1
      && data.name.size() <= 100
      && data.workspaceId is string
      && data.status in ['draft', 'live']
      && data.activeEventId == null  // No active event on creation
      && data.deletedAt == null      // Not deleted on creation
      && data.createdAt is timestamp
      && data.updatedAt is timestamp;
  }

  // Helper: Validate project data structure on soft delete
  function isValidDeleteUpdate() {
    let data = request.resource.data;
    return data.status == 'deleted'
      && data.deletedAt is timestamp
      && data.updatedAt is timestamp
      && data.workspaceId == resource.data.workspaceId;  // Prevent workspace transfer
  }

  // Helper: Validate project data structure on general update
  function isValidGeneralUpdate() {
    let data = request.resource.data;
    return data.updatedAt is timestamp
      && data.workspaceId == resource.data.workspaceId  // Prevent workspace transfer
      && data.status != 'deleted';  // Can't un-delete via general update
  }

  // READ: Allow if user is admin of project's workspace AND project is not deleted
  // Soft-deleted projects are invisible at the database level
  allow read: if isWorkspaceAdmin(resource.data.workspaceId)
    && resource.data.status != 'deleted';

  // CREATE: Allow if user is admin of workspace AND data structure is valid
  allow create: if isWorkspaceAdmin(request.resource.data.workspaceId)
    && isValidCreateData();

  // UPDATE (soft delete): Allow if user is admin AND performing valid soft delete
  allow update: if isWorkspaceAdmin(resource.data.workspaceId)
    && isValidDeleteUpdate();

  // UPDATE (general): Allow if user is admin AND performing valid update
  // This covers name changes, status changes (draft <-> live), activeEventId updates
  allow update: if isWorkspaceAdmin(resource.data.workspaceId)
    && isValidGeneralUpdate();

  // DELETE (hard delete): Forbidden - only soft deletes allowed
  allow delete: if false;
}
