# Implementation Plan: Flatten Project/Event Structure

**Branch**: `042-flatten-structure-refactor` | **Date**: 2026-01-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/042-flatten-structure-refactor/spec.md`

## Summary

Flatten the nested project/event data model by merging `ProjectEventConfig` directly into the `Project` document. This eliminates the `/projects/{projectId}/events/{eventId}` subcollection, reducing query complexity, cognitive overhead, and code duplication while maintaining all existing functionality.

## Technical Context

**Language/Version**: TypeScript 5.7.2 (strict mode, ES2022 target)
**Primary Dependencies**: TanStack Start 1.132.0, React 19.2.0, Firebase SDK 12.5.0, Zod 4.1.12, TanStack Query 5.66.5
**Storage**: Firebase Firestore (NoSQL database)
**Testing**: Vitest (frontend), Jest (functions)
**Target Platform**: Web (mobile-first responsive)
**Project Type**: Web application (monorepo with apps/clementine-app, functions/, packages/shared)
**Performance Goals**: Page load < 2s on 4G, AI transformation < 60s
**Constraints**: Mobile-first (320px-768px primary), client-first architecture with Firestore rules
**Scale/Scope**: Single-event per project (95% of use cases), 177 files with projectId references, 86 files with eventId references

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Mobile-First Design | PASS | No UI changes that affect mobile experience |
| II. Clean Code & Simplicity | PASS | This refactor **reduces** complexity by eliminating unnecessary abstraction |
| III. Type-Safe Development | PASS | All schemas will remain Zod-validated, strict TypeScript |
| IV. Minimal Testing Strategy | PASS | Update existing tests, focus on critical user flows |
| V. Validation Gates | PASS | Run `pnpm app:check` before commits, verify in dev server |
| VI. Frontend Architecture | PASS | Maintains client-first pattern with Firestore SDK |
| VII. Backend & Firebase | PASS | Simplifies Firestore paths, updates security rules |
| VIII. Project Structure | PASS | Follows vertical slice architecture |

**Pre-Design Gate**: PASSED - No constitution violations identified.

## Project Structure

### Documentation (this feature)

```text
specs/042-flatten-structure-refactor/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (N/A - no new APIs)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Monorepo structure - affected areas

packages/shared/
├── src/schemas/
│   ├── project/
│   │   ├── project.schema.ts           # MODIFY: Add config fields, remove activeEventId
│   │   ├── project-config.schema.ts    # NEW (from event/project-event-config.schema.ts)
│   │   ├── experiences.schema.ts       # NEW (from event/experiences.schema.ts)
│   │   └── index.ts                    # MODIFY: Export new schemas
│   ├── event/                          # DELETE: Entire folder after moving files
│   │   ├── project-event.schema.ts     # DELETE: No longer needed
│   │   ├── project-event-config.schema.ts  # MOVE → project/project-config.schema.ts
│   │   ├── experiences.schema.ts       # MOVE → project/experiences.schema.ts
│   │   └── index.ts                    # DELETE: Folder removed
│   └── session/
│       └── session.schema.ts           # MODIFY: Remove eventId field

apps/clementine-app/
├── src/
│   ├── app/routes/
│   │   └── workspace/$workspaceSlug.projects/
│   │       ├── $projectId.tsx                    # MODIFY: Load config from project
│   │       ├── $projectId.events/                # DELETE: Entire directory
│   │       │   ├── $eventId.tsx
│   │       │   ├── $eventId.welcome.tsx
│   │       │   ├── $eventId.share.tsx
│   │       │   ├── $eventId.theme.tsx
│   │       │   ├── $eventId.settings.tsx
│   │       │   └── index.tsx
│   │       └── # NEW routes under $projectId for config pages
│   └── domains/
│       ├── event/                   # RENAME → project-config/
│       │   ├── shared/              # UPDATE: Remove eventId from hooks/queries
│       │   ├── designer/            # UPDATE: usePublishEvent → usePublishProjectConfig
│       │   ├── theme/               # UPDATE: Remove eventId param
│       │   ├── welcome/             # UPDATE: Remove eventId param
│       │   ├── share/               # UPDATE: Remove eventId param
│       │   ├── settings/            # UPDATE: Remove eventId param
│       │   └── experiences/         # UPDATE: Remove eventId param
│       ├── project/
│       │   ├── shared/              # UPDATE: useProject returns full config
│       │   └── events/              # DELETE: Event CRUD hooks no longer needed
│       └── project-config/        # NEW (renamed from event/)

functions/
├── src/
│   ├── repositories/
│   │   └── # UPDATE: Remove event repository references
│   └── services/
│       └── # UPDATE: Fetch config from project document

firebase/
└── firestore.rules      # MODIFY: Remove events subcollection rules
```

**Structure Decision**:
- **packages/shared**: Move schema files from `event/` to `project/` folder, then delete `event/` folder
- **domains**: Rename `event/` to `project-config/` (simpler than merging into `project/`). Update hooks to remove `eventId` param.

## Complexity Tracking

> No constitution violations requiring justification. This refactor reduces complexity.

| Aspect | Before | After | Improvement |
|--------|--------|-------|-------------|
| Firestore queries | 2 reads (project + event) | 1 read (project) | 50% reduction |
| Route depth | 4 segments (workspace/projects/projectId/events/eventId) | 3 segments (workspace/projects/projectId/config) | Simpler URLs |
| Schema count | 2 main schemas (Project + ProjectEventFull) | 1 combined schema (Project) | Fewer types |
| Mental model | "Project contains events with config" | "Project has config" | Clearer |

## Phase Summary

### Phase 1: Schema Changes (packages/shared)
- Expand `projectSchema` with config fields from `ProjectEventFull`
- Rename `projectEventConfigSchema` → `projectConfigSchema`
- Delete `projectEventFullSchema` and `projectEventStatusSchema`
- Remove `activeEventId` from project schema
- Remove `eventId` from session schema
- Update all schema exports

### Phase 2: Backend Changes (functions/)
- Update job creation to reference project config directly
- Update session creation (remove eventId requirement)
- Remove any event repository code
- Update cloud function triggers if any reference events

### Phase 3: Frontend Route Restructure (apps/clementine-app/routes)
- Delete `/projects/$projectId/events/` route directory
- Create new routes under `/projects/$projectId/` for config pages
- Update route params and loaders

### Phase 4: Frontend Domain Rename (apps/clementine-app/domains)
- Rename `domains/event/` → `domains/project-config/`
- Delete `domains/project/events/` (event CRUD hooks no longer needed)
- Remove `eventId` param from all hooks in project-config/
- Rename files/components/hooks that reference "event":
  - `EventDesignerLayout` → `ProjectConfigDesignerLayout`
  - `EventDesignerSidebar` → `ProjectConfigDesignerSidebar`
  - `EventSettingsPage` → `ProjectConfigSettingsPage`
  - `useProjectEvent` → `useProjectConfig`
  - `usePublishEvent` → `usePublishProjectConfig`
  - `updateEventConfigField` → `updateProjectConfigField`
- Update `useProject` to return full project with config
- Update all imports from `@/domains/event/` → `@/domains/project-config/`

### Phase 5: Security Rules (firebase/)
- Remove `/projects/{projectId}/events/{eventId}` match block
- Project-level rules already cover config access

### Phase 6: Data Migration (one-time)
- Script to flatten existing event data into project documents
- Mark old events for cleanup
