openapi: 3.1.0
info:
  title: Project Events Management API
  version: 1.0.0
  description: |
    API contract for managing project events within projects.

    **NOTE**: This is for DOCUMENTATION ONLY. The actual implementation uses
    Firestore client SDK (not REST API). This contract describes the logical
    API surface in OpenAPI format for clarity and reference.

    **Firestore Structure**: Project events are stored in subcollections:
    `projects/{projectId}/events/{eventId}`

    The `projectId` is implicit in the document path, NOT stored as a field.

    **Authentication**: All endpoints require workspace admin authorization.
    Security is enforced via Firebase Firestore security rules with simple
    admin checks only (per `standards/backend/firestore-security.md`).

    **Validation**: Data validation happens in application code using Zod schemas,
    NOT in Firestore security rules.

servers:
  - url: https://firestore.googleapis.com/v1
    description: Firebase Firestore (client SDK)

tags:
  - name: Project Events
    description: Project event management operations (create, read, update, delete, activate)

paths:
  /projects/{projectId}/events:
    get:
      summary: Get all project events for a project
      description: |
        Returns all non-deleted project events for a project, ordered by creation date (newest first).
        Only accessible by workspace admins.

        Implementation: Firestore subcollection query
        Path: `projects/{projectId}/events`
        Filter: `where('status', '==', 'draft')`
      operationId: getProjectEvents
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID (determines subcollection path)
      responses:
        '200':
          description: List of project events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProjectEvent'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new project event
      description: |
        Creates a new project event for a project with status "draft".
        The project event is not active by default.
        Only accessible by workspace admins.

        Implementation: Firestore subcollection addDoc
        Path: `projects/{projectId}/events`
        Validation: Zod schema validation in application code (NOT security rules)
      operationId: createProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID (determines subcollection path)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectEventInput'
      responses:
        '201':
          description: Project event created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectEvent'
        '400':
          description: Bad Request - Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /projects/{projectId}/events/{eventId}:
    get:
      summary: Get a single project event by ID
      description: |
        Returns a single project event by ID.
        Returns 404 if project event doesn't exist or is deleted.
        Only accessible by workspace admins.

        Implementation: Firestore document get
        Path: `projects/{projectId}/events/{eventId}`
      operationId: getProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID (for subcollection path)
        - name: eventId
          in: path
          required: true
          schema:
            type: string
          description: Project event ID
      responses:
        '200':
          description: Project event found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectEvent'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project event not found or deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      summary: Rename a project event
      description: |
        Updates the name of an existing project event.
        Only accessible by workspace admins.

        Implementation: Firestore updateDoc on subcollection document
        Validation: Zod schema validation in application code (NOT security rules)
      operationId: renameProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID (for subcollection path)
        - name: eventId
          in: path
          required: true
          schema:
            type: string
          description: Project event ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProjectEventInput'
      responses:
        '200':
          description: Project event renamed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectEvent'
        '400':
          description: Bad Request - Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project event not found or deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Soft-delete a project event
      description: |
        Soft-deletes a project event by setting status to "deleted".
        If the project event is currently active, the project will have no active event.
        Only accessible by workspace admins.

        Implementation: Firestore transaction (soft delete + clear activeEventId if needed)
      operationId: deleteProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID (for subcollection path)
        - name: eventId
          in: path
          required: true
          schema:
            type: string
          description: Project event ID
      responses:
        '200':
          description: Project event deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectEvent'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project event not found or already deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /projects/{projectId}/events/{eventId}/activate:
    post:
      summary: Activate a project event
      description: |
        Activates a project event for a project.
        Only one project event can be active per project. If another project event is currently
        active, it will be automatically deactivated.
        Only accessible by workspace admins.

        Implementation: Firestore transaction (verify event + atomically update project.activeEventId)
      operationId: activateProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID
        - name: eventId
          in: path
          required: true
          schema:
            type: string
          description: Project event ID to activate
      responses:
        '200':
          description: Project event activated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectEvent'
        '400':
          description: Bad Request - Cannot activate deleted project event
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project event not found, deleted, or doesn't belong to project
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /projects/{projectId}/active-event:
    get:
      summary: Get the currently active project event for a project
      description: |
        Returns the currently active project event for a project.
        Returns null if no project event is active.
        Only accessible by workspace admins.

        Implementation: Read project.activeEventId, then fetch event from subcollection
      operationId: getActiveProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID
      responses:
        '200':
          description: Active project event (or null if none)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ProjectEvent'
                  - type: "null"
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Deactivate the currently active project event
      description: |
        Deactivates the currently active project event for a project.
        After deactivation, the project will have no active project event.
        Only accessible by workspace admins.

        Implementation: Update project.activeEventId to null
      operationId: deactivateProjectEvent
      tags:
        - Project Events
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: Project ID
      responses:
        '200':
          description: Project event deactivated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '403':
          description: Forbidden - User is not workspace admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    ProjectEvent:
      type: object
      description: |
        An AI-powered photo booth experience within a project.

        Stored in Firestore subcollection: `projects/{projectId}/events/{eventId}`

        Note: projectId is implicit in the subcollection path, NOT stored as a field.
      required:
        - id
        - name
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: Unique identifier (Firestore document ID)
          example: "evt_abc123"
        name:
          type: string
          description: Project event display name
          minLength: 1
          maxLength: 100
          example: "Summer Festival 2026"
        status:
          $ref: '#/components/schemas/ProjectEventStatus'
        createdAt:
          type: integer
          description: Creation timestamp (milliseconds since epoch)
          example: 1704067200000
        updatedAt:
          type: integer
          description: Last update timestamp (milliseconds since epoch)
          example: 1704153600000
        deletedAt:
          type: integer
          nullable: true
          description: Soft delete timestamp (null if not deleted)
          example: null

    ProjectEventStatus:
      type: string
      description: Project event lifecycle status
      enum:
        - draft
        - deleted
      example: "draft"

    CreateProjectEventInput:
      type: object
      description: |
        Input for creating a new project event.

        Note: projectId is NOT in the input - it's determined by the subcollection path.
      properties:
        name:
          type: string
          description: Project event name (defaults to "Untitled event" if not provided)
          minLength: 1
          maxLength: 100
          default: "Untitled event"
          example: "Summer Festival 2026"

    UpdateProjectEventInput:
      type: object
      description: Input for updating an existing project event
      required:
        - name
      properties:
        name:
          type: string
          description: New project event name
          minLength: 1
          maxLength: 100
          example: "Summer Festival 2026 - Updated"

    Error:
      type: object
      description: Error response
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          enum:
            - NOT_FOUND
            - FORBIDDEN
            - BAD_REQUEST
            - INTERNAL_ERROR
          example: "NOT_FOUND"
        message:
          type: string
          description: Human-readable error message
          example: "Project event not found"
        details:
          type: string
          description: Additional error context
          example: "Project event evt_abc123 does not exist or has been deleted"

  securitySchemes:
    FirebaseAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Firebase Authentication JWT token with admin custom claim.

        Security Rules: Simple admin checks only (per standards/backend/firestore-security.md)

        ```javascript
        match /projects/{projectId}/events/{eventId} {
          allow read: if isAdmin();
          allow create, update: if isAdmin();
          allow delete: if false;  // Soft delete only
        }
        ```

        Data Validation: Handled by Zod schemas in application code, NOT in security rules.

security:
  - FirebaseAuth: []
