# Contract: submitGuestEmail (Callable Function)
#
# Saves a guest's email address to a session for result delivery.
# Called from the guest loading screen email capture form.
# If the job is already completed, queues sendSessionEmail immediately.
#
# Type: Firebase Callable Function (onCall)
# Auth: None required (guest users are anonymous)

id: CF-001
name: submitGuestEmail
type: callable
region: europe-west1

request:
  schema:
    projectId:
      type: string
      required: true
      description: Project ID that owns the session
    sessionId:
      type: string
      required: true
      description: Session ID to attach email to
    email:
      type: string
      format: email
      required: true
      description: Guest's email address (validated with Zod z.string().email())

response:
  success:
    schema:
      success:
        type: boolean
        value: true
  errors:
    - code: invalid-argument
      description: Email validation failed or missing required fields
    - code: not-found
      description: Session not found for given projectId/sessionId
    - code: already-exists
      description: Email already submitted for this session (guestEmail already set)

behavior:
  - Validate payload with Zod schema
  - Fetch session document
  - Verify session exists and guestEmail is null (prevent overwrite)
  - Write guestEmail to session document
  - Check if jobStatus === 'completed' and resultMedia exists
  - If yes: queue sendSessionEmail Cloud Task (immediate email send)
  - Return success

notes:
  - Handles the "email submitted after job completed" timing case
  - For the "job completes after email submitted" case, transformPipelineJob queues sendSessionEmail
  - Does NOT require authentication â€” guest sessions are anonymous
  - The guestEmail field is PII and must not be logged
