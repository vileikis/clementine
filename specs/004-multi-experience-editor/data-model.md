# Data Model: Multi-Experience Type Editor

**Feature**: 004-multi-experience-editor
**Date**: 2025-11-20
**Source**: Existing schemas in `web/src/features/experiences/lib/schemas.ts`

---

## Overview

This feature works with existing Experience entities stored in Firebase Firestore. The Experience entity uses a **discriminated union** pattern where all experiences share base fields but have type-specific configuration structures.

**Key Principle**: The `type` field acts as the discriminant that determines which config structure applies.

---

## Entity: Experience (Discriminated Union)

### Location in Firestore

```
events/{eventId}/experiences/{experienceId}
```

### Base Fields (Shared Across All Types)

All experience types include these fields:

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `id` | string | Yes | Generated by Firestore | Unique experience identifier |
| `eventId` | string | Yes | Valid event ID | Parent event reference |
| `type` | enum | Yes | `"photo" \| "video" \| "gif" \| "wheel" \| "survey"` | Discriminant field determining config structure |
| `label` | string | Yes | 1-50 characters, trimmed | Display name for experience |
| `enabled` | boolean | Yes | - | Whether guests can access this experience |
| `hidden` | boolean | Yes | Default: false | Whether experience appears in sidebar (for future use) |
| `previewPath` | string | No | Valid URL or undefined | Public URL to preview media |
| `previewType` | enum | No | `"image" \| "gif" \| "video"` or undefined | Type of preview media |
| `createdAt` | number | Yes | Positive integer timestamp (ms since epoch) | Creation timestamp |
| `updatedAt` | number | Yes | Positive integer timestamp (ms since epoch) | Last update timestamp |

---

## Photo Experience (`type: "photo"`)

### Type-Specific Fields

**config** (PhotoConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `countdown` | number | Yes | 0-10 inclusive | Countdown timer in seconds (0 = disabled) |
| `overlayFramePath` | string \| null | Yes | Valid URL or null | Public URL to overlay frame PNG |

**aiConfig** (AiConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `enabled` | boolean | Yes | - | Whether AI transformation is enabled |
| `model` | string \| null | Yes | Non-empty string or null | AI model identifier (e.g., "nanobanana") |
| `prompt` | string \| null | Yes | Max 600 characters or null | AI transformation prompt |
| `referenceImagePaths` | string[] \| null | Yes | Max 5 URLs or null | Reference images for AI |
| `aspectRatio` | enum | Yes | `"1:1" \| "3:4" \| "4:5" \| "9:16" \| "16:9"` | Output aspect ratio |

### Example Document

```json
{
  "id": "exp_abc123",
  "eventId": "evt_xyz789",
  "type": "photo",
  "label": "Neon Portrait",
  "enabled": true,
  "hidden": false,
  "previewPath": "https://storage.googleapis.com/.../preview.jpg",
  "previewType": "image",
  "config": {
    "countdown": 3,
    "overlayFramePath": "https://storage.googleapis.com/.../frame.png"
  },
  "aiConfig": {
    "enabled": true,
    "model": "nanobanana",
    "prompt": "Transform into cyberpunk neon style",
    "referenceImagePaths": [
      "https://storage.googleapis.com/.../ref1.jpg",
      "https://storage.googleapis.com/.../ref2.jpg"
    ],
    "aspectRatio": "1:1"
  },
  "createdAt": 1700000000000,
  "updatedAt": 1700000001000
}
```

---

## GIF Experience (`type: "gif"`)

### Type-Specific Fields

**config** (GifConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `frameCount` | number | Yes | 3-10 inclusive | Number of frames to capture |
| `intervalMs` | number | Yes | 100-1000 inclusive | Milliseconds between frame captures |
| `loopCount` | number | Yes | 0+ (0 = infinite) | Number of times GIF loops |
| `countdown` | number | No | 0-10 inclusive or undefined | Optional countdown before first frame |

**aiConfig** (AiConfig object):

Same structure as Photo experience (see above). GIF experiences support AI transformation.

### Example Document

```json
{
  "id": "exp_def456",
  "eventId": "evt_xyz789",
  "type": "gif",
  "label": "Animated Selfie",
  "enabled": true,
  "hidden": false,
  "previewPath": "https://storage.googleapis.com/.../preview.gif",
  "previewType": "gif",
  "config": {
    "frameCount": 5,
    "intervalMs": 500,
    "loopCount": 0,
    "countdown": 3
  },
  "aiConfig": {
    "enabled": false,
    "model": null,
    "prompt": null,
    "referenceImagePaths": null,
    "aspectRatio": "1:1"
  },
  "createdAt": 1700000002000,
  "updatedAt": 1700000002000
}
```

---

## Video Experience (`type: "video"`) - Future

### Type-Specific Fields

**config** (VideoConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `maxDurationSeconds` | number | Yes | 1-60 inclusive | Maximum video duration |
| `allowRetake` | boolean | Yes | - | Whether guest can retake video |
| `countdown` | number | No | 0-10 inclusive or undefined | Optional countdown before recording |

**aiConfig** (AiConfig object):

Same structure as Photo/GIF experiences. Video experiences support AI transformation.

---

## Wheel Experience (`type: "wheel"`) - Future

### Type-Specific Fields

**config** (WheelConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `items` | WheelItem[] | Yes | 2-12 items | Wheel segments |
| `spinDurationMs` | number | Yes | 2000-5000 inclusive | Spin animation duration |
| `autoSpin` | boolean | Yes | - | Whether wheel spins automatically |

**WheelItem** structure:

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `id` | string | Yes | Unique within wheel | Item identifier |
| `label` | string | Yes | Non-empty | Text displayed on segment |
| `weight` | number | Yes | Positive | Probability weight |
| `color` | string | Yes | Hex color (#RRGGBB) | Segment background color |
| `imagePath` | string | No | Valid URL or undefined | Optional image for segment |

**Note**: Wheel experiences do NOT have `aiConfig`.

---

## Survey Experience (`type: "survey"`) - Future

### Type-Specific Fields

**config** (SurveyConfig object):

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `surveyStepIds` | string[] | Yes | Array of step IDs | Ordered list of survey steps |
| `required` | boolean | Yes | - | Whether survey completion is required |
| `showProgressBar` | boolean | Yes | - | Whether to show progress indicator |

**Note**: Survey experiences do NOT have `aiConfig`. Survey steps are stored in separate `surveySteps` subcollection.

---

## Validation Rules

### Base Field Validation

```typescript
// From baseExperienceSchema
{
  id: z.string(),
  eventId: z.string(),
  type: z.enum(["photo", "video", "gif", "wheel", "survey"]),
  label: z.string().min(1).max(50),
  enabled: z.boolean(),
  hidden: z.boolean().default(false),
  previewPath: z.string().url().optional(),
  previewType: z.enum(["image", "gif", "video"]).optional(),
  createdAt: z.number().int().positive(),
  updatedAt: z.number().int().positive(),
}
```

### Photo Config Validation

```typescript
// From photoConfigSchema
{
  countdown: z.number().int().min(0).max(10),
  overlayFramePath: z.string().url().nullable(),
}
```

### GIF Config Validation

```typescript
// From gifConfigSchema
{
  frameCount: z.number().int().min(3).max(10),
  intervalMs: z.number().int().min(100).max(1000),
  loopCount: z.number().int().min(0),
  countdown: z.number().int().min(0).max(10).optional(),
}
```

### AI Config Validation (Shared)

```typescript
// From aiConfigSchema
{
  enabled: z.boolean(),
  model: z.string().nullable(),
  prompt: z.string().max(600).nullable(),
  referenceImagePaths: z.array(z.string().url()).max(5).nullable(),
  aspectRatio: z.enum(["1:1", "3:4", "4:5", "9:16", "16:9"]),
}
```

---

## State Transitions

Experiences are **configuration entities** with no complex state machine. However, they have lifecycle states:

1. **Creation**: Experience created with `createdAt` timestamp, default configuration
2. **Update**: Any field can be updated except `id`, `eventId`, `type`, `createdAt`
3. **Enable/Disable**: `enabled` field toggles whether guests can access the experience
4. **Deletion**: Experience document removed from Firestore

**Important**: The `type` field is **immutable after creation**. Cannot change photo â†’ gif or vice versa.

---

## Relationships

### Parent: Event

- Each experience belongs to exactly one event
- Stored in subcollection: `events/{eventId}/experiences/{experienceId}`
- Deleting an event should cascade delete all its experiences (handled by Firestore rules or cloud functions)

### Children: None

- Experiences have no child entities in this feature
- Future: Wheel experiences may reference `experienceItems` subcollection
- Future: Survey experiences reference `surveySteps` collection

### References

- `overlayFramePath`: Points to Firebase Storage public URL
- `referenceImagePaths`: Array of Firebase Storage public URLs
- `previewPath`: Points to Firebase Storage public URL

---

## Firestore Indexes

No custom indexes required for this feature. Querying experiences by event ID uses the collection group structure which has automatic indexing.

Potential future indexes if querying patterns change:

```
Collection: experiences
Fields: eventId ASC, enabled ASC
(To efficiently query enabled experiences for an event)

Collection: experiences
Fields: eventId ASC, type ASC
(To query experiences by type within an event)
```

---

## Migration Notes

This feature works with the **existing schema** defined in `web/src/features/experiences/lib/schemas.ts`. No database migration is required.

The schema was consolidated in feature `001-experience-type-fix` which:
- Removed legacy flat schema
- Established discriminated union pattern
- Defined nested `config` and `aiConfig` objects

All existing photo experiences in development Firestore already use this structure.

---

## Security Considerations

**Firestore Security Rules** (existing, no changes needed):

```
// Allow reads, deny writes - all mutations via Server Actions
match /events/{eventId}/experiences/{experienceId} {
  allow read: if true; // Anyone can read (for guest experience rendering)
  allow write: if false; // All writes go through Admin SDK via Server Actions
}
```

**Server-Side Validation**:
- All create/update operations validate input with Zod schemas
- Type-specific schemas ensure correct config structure
- Admin SDK bypasses security rules but still validates business logic

**Public URLs**:
- `overlayFramePath`, `referenceImagePaths`, `previewPath` are all public URLs
- No signed URLs needed (images render instantly)
- Storage bucket configured for public read access on `/experiences/` prefix

---

## Performance Considerations

**Read Performance**:
- Experiences loaded once when event designer opens
- No real-time subscriptions needed (config changes are infrequent)
- Client SDK can be used for optimistic reads if needed

**Write Performance**:
- Updates are infrequent (creator configuration, not guest interaction)
- No performance concerns with current schema

**Storage**:
- Each experience: ~1-2KB (config + metadata)
- 100 experiences per event: ~100-200KB total
- Well within Firestore document size limits (1MB)

---

## Summary

The Experience entity uses a discriminated union pattern with:
- **5 variants**: Photo, Video, GIF, Wheel, Survey
- **Shared base fields**: id, eventId, type, label, enabled, hidden, preview, timestamps
- **Type-specific config**: Each variant has unique configuration structure
- **Optional AI support**: Photo, Video, GIF have aiConfig; Wheel, Survey do not

This feature focuses on **Photo and GIF** variants with an architecture that makes adding the remaining variants straightforward.
