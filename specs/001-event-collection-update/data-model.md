# Data Model: Event Collection Schema Refactor

**Feature**: 001-event-collection-update
**Date**: 2025-11-19
**Status**: Final

## Overview

This document defines the refactored Event schema with nested objects for welcome, ending, share, and theme configuration. The schema replaces flat prefixed fields with semantic groupings to improve maintainability and developer experience.

---

## Entities

### Event (Firestore: `/events/{eventId}`)

Root event configuration document stored in Firestore. Contains nested objects for welcome screen, ending screen, share settings, and theme customization.

**Collection Path**: `/events/{eventId}`

#### Fields

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `id` | `string` | Yes | Unique event identifier (Firestore document ID) | Auto-generated by Firestore |
| `title` | `string` | Yes | Event title/name | 1-200 characters |
| `status` | `EventStatus` | Yes | Event lifecycle status | Enum: "draft" \| "live" \| "archived" |
| `companyId` | `string \| null` | Yes | Foreign key to companies collection (nullable) | Valid company ID or null |
| `joinPath` | `string` | Yes | Guest-facing join URL path | Format: "/join/{code}" |
| `qrPngPath` | `string` | Yes | QR code image storage path (full public URL) | Valid URL |
| `publishStartAt` | `number` | No | Event visibility start time (Unix timestamp ms) | Optional timestamp |
| `publishEndAt` | `number` | No | Event visibility end time (Unix timestamp ms) | Optional timestamp |
| `theme` | `EventTheme` | No | Event-wide theme settings (colors, backgrounds) | See EventTheme schema |
| `welcome` | `EventWelcome` | No | Welcome screen configuration | See EventWelcome schema |
| `ending` | `EventEnding` | No | Ending screen configuration | See EventEnding schema |
| `share` | `EventShareConfig` | Yes | Share settings (download, email, socials) | See EventShareConfig schema |
| `experiencesCount` | `number` | Yes | Denormalized count of experiences for this event | Default: 0 |
| `sessionsCount` | `number` | Yes | Denormalized count of sessions for this event | Default: 0 |
| `readyCount` | `number` | Yes | Denormalized count of sessions in "ready" state | Default: 0 |
| `sharesCount` | `number` | Yes | Denormalized count of shares for this event | Default: 0 |
| `createdAt` | `number` | Yes | Event creation timestamp (Unix ms) | Auto-set on creation |
| `updatedAt` | `number` | Yes | Last update timestamp (Unix ms) | Auto-updated on write |

#### Deprecated Fields (DO NOT USE)

These fields are deprecated and MUST NOT be written to Firestore. Firestore security rules will deny writes containing these keys.

- ❌ `brandColor` - Replaced by `theme.buttonColor`
- ❌ `showTitleOverlay` - Removed (feature cancelled)
- ❌ `surveyEnabled` - Removed (feature cancelled)
- ❌ `surveyRequired` - Removed (feature cancelled)
- ❌ `surveyStepsCount` - Removed (feature cancelled)
- ❌ `surveyStepsOrder` - Removed (feature cancelled)
- ❌ `surveyVersion` - Removed (feature cancelled)
- ❌ `welcomeTitle` - Replaced by `welcome.title`
- ❌ `welcomeDescription` - Replaced by `welcome.body`
- ❌ `welcomeCtaLabel` - Replaced by `welcome.ctaLabel`
- ❌ `welcomeBackgroundImagePath` - Replaced by `welcome.backgroundImage`
- ❌ `welcomeBackgroundColorHex` - Replaced by `welcome.backgroundColor`
- ❌ `endHeadline` - Replaced by `ending.title`
- ❌ `endBody` - Replaced by `ending.body`
- ❌ `endCtaLabel` - Replaced by `ending.ctaLabel`
- ❌ `endCtaUrl` - Replaced by `ending.ctaUrl`
- ❌ `shareAllowDownload` - Replaced by `share.allowDownload`
- ❌ `shareAllowSystemShare` - Replaced by `share.allowSystemShare`
- ❌ `shareAllowEmail` - Replaced by `share.allowEmail`
- ❌ `shareSocials` - Replaced by `share.socials`

---

### EventTheme (Nested Object)

Event-wide theme settings for visual customization (button colors, backgrounds).

**Parent**: `Event.theme`

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `buttonColor` | `string` | No | Primary button background color | Hex color (e.g., "#3B82F6") |
| `buttonTextColor` | `string` | No | Primary button text color | Hex color (e.g., "#FFFFFF") |
| `backgroundColor` | `string` | No | Event-wide background color | Hex color (e.g., "#F9FAFB") |
| `backgroundImage` | `string` | No | Event-wide background image (full public URL) | Valid URL |

**Example**:
```json
{
  "theme": {
    "buttonColor": "#3B82F6",
    "buttonTextColor": "#FFFFFF",
    "backgroundColor": "#F9FAFB",
    "backgroundImage": "https://storage.googleapis.com/..."
  }
}
```

---

### EventWelcome (Nested Object)

Welcome screen configuration shown to guests when they first join an event.

**Parent**: `Event.welcome`

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `title` | `string` | No | Welcome screen headline | Max 500 characters |
| `body` | `string` | No | Welcome screen description/body text | Max 500 characters |
| `ctaLabel` | `string` | No | Welcome screen CTA button label | Max 50 characters |
| `backgroundImage` | `string` | No | Welcome screen background image (full public URL) | Valid URL |
| `backgroundColor` | `string` | No | Welcome screen background color | Hex color (e.g., "#FFFFFF") |

**Example**:
```json
{
  "welcome": {
    "title": "Welcome to TechCon 2025!",
    "body": "Take a photo and share it with your friends!",
    "ctaLabel": "Get Started",
    "backgroundColor": "#FFFFFF",
    "backgroundImage": "https://storage.googleapis.com/..."
  }
}
```

---

### EventEnding (Nested Object)

Ending screen configuration shown to guests after completing an experience.

**Parent**: `Event.ending`

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `title` | `string` | No | Ending screen headline | Max 500 characters |
| `body` | `string` | No | Ending screen body text | Max 500 characters |
| `ctaLabel` | `string` | No | Ending screen CTA button label | Max 50 characters |
| `ctaUrl` | `string` | No | Ending screen CTA button destination URL | Valid URL |

**Example**:
```json
{
  "ending": {
    "title": "Thanks for joining us!",
    "body": "Visit our website to learn more about our products.",
    "ctaLabel": "Visit Website",
    "ctaUrl": "https://example.com"
  }
}
```

---

### EventShareConfig (Nested Object)

Share settings controlling how guests can share their generated media.

**Parent**: `Event.share`

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `allowDownload` | `boolean` | Yes | Enable download button | Default: true |
| `allowSystemShare` | `boolean` | Yes | Enable native system share sheet | Default: true |
| `allowEmail` | `boolean` | Yes | Enable email share option | Default: false |
| `socials` | `ShareSocial[]` | Yes | Array of enabled social platforms | Array of enum values, default: [] |

**Example**:
```json
{
  "share": {
    "allowDownload": true,
    "allowSystemShare": true,
    "allowEmail": false,
    "socials": ["instagram", "tiktok", "facebook"]
  }
}
```

---

### ShareSocial (Enum)

Social platform options for sharing.

**Type**: `string` (enum)

**Values**:
- `"instagram"` - Instagram sharing
- `"tiktok"` - TikTok sharing
- `"facebook"` - Facebook sharing
- `"x"` - X (formerly Twitter) sharing
- `"snapchat"` - Snapchat sharing
- `"whatsapp"` - WhatsApp sharing
- `"custom"` - Custom social platform link

---

### EventStatus (Enum)

Event lifecycle status.

**Type**: `string` (enum)

**Values**:
- `"draft"` - Event is being configured, not visible to guests
- `"live"` - Event is active and accessible via joinPath
- `"archived"` - Event is completed, no longer active

---

## Relationships

### Event → Company (Many-to-One)

- `Event.companyId` is a foreign key to `/companies/{companyId}`
- Optional relationship (companyId can be null for standalone events)
- No Firestore-enforced referential integrity (handled at application level)

### Event → Experiences (One-to-Many)

- Experiences are stored in subcollection: `/events/{eventId}/experiences/{experienceId}`
- Not affected by this schema refactor (experiences schema unchanged)

### Event → Sessions (One-to-Many)

- Sessions are stored in subcollection: `/events/{eventId}/sessions/{sessionId}`
- Not affected by this schema refactor (sessions schema unchanged)

---

## State Transitions

### Event Status Lifecycle

```
draft → live → archived
  ↓      ↓
  └──────┘
  (can transition back to draft from live)
```

**Transitions**:
1. **draft → live**: Event creator publishes event (makes it accessible to guests)
2. **live → archived**: Event ends, moved to archived state
3. **live → draft**: Event creator unpublishes event (makes it inaccessible to guests)
4. **draft → archived**: Event creator archives draft without publishing

---

## Validation Rules

### Zod Schemas

All Event data must validate against Zod schemas defined in `web/src/lib/schemas/event.ts`:

**EventTheme Schema**:
```typescript
export const eventThemeSchema = z.object({
  buttonColor: z.string().regex(/^#[0-9A-F]{6}$/i).optional(),
  buttonTextColor: z.string().regex(/^#[0-9A-F]{6}$/i).optional(),
  backgroundColor: z.string().regex(/^#[0-9A-F]{6}$/i).optional(),
  backgroundImage: z.string().url().optional(),
});
```

**EventWelcome Schema**:
```typescript
export const eventWelcomeSchema = z.object({
  title: z.string().max(500).optional(),
  body: z.string().max(500).optional(),
  ctaLabel: z.string().max(50).optional(),
  backgroundImage: z.string().url().optional(),
  backgroundColor: z.string().regex(/^#[0-9A-F]{6}$/i).optional(),
});
```

**EventEnding Schema**:
```typescript
export const eventEndingSchema = z.object({
  title: z.string().max(500).optional(),
  body: z.string().max(500).optional(),
  ctaLabel: z.string().max(50).optional(),
  ctaUrl: z.string().url().optional(),
});
```

**EventShareConfig Schema**:
```typescript
export const shareSocialSchema = z.enum([
  "instagram", "tiktok", "facebook", "x", "snapchat", "whatsapp", "custom"
]);

export const eventShareConfigSchema = z.object({
  allowDownload: z.boolean().default(true),
  allowSystemShare: z.boolean().default(true),
  allowEmail: z.boolean().default(false),
  socials: z.array(shareSocialSchema).default([]),
});
```

**Event Schema (Complete)**:
```typescript
export const eventSchema = z.object({
  id: z.string(),
  title: z.string().min(1).max(200),
  status: z.enum(["draft", "live", "archived"]),
  companyId: z.string().nullable().default(null),
  joinPath: z.string(),
  qrPngPath: z.string().url(),
  publishStartAt: z.number().optional(),
  publishEndAt: z.number().optional(),
  theme: eventThemeSchema.optional(),
  welcome: eventWelcomeSchema.optional(),
  ending: eventEndingSchema.optional(),
  share: eventShareConfigSchema,
  experiencesCount: z.number().default(0),
  sessionsCount: z.number().default(0),
  readyCount: z.number().default(0),
  sharesCount: z.number().default(0),
  createdAt: z.number(),
  updatedAt: z.number(),
});
```

### Firestore Security Rules

Firestore security rules enforce schema compliance at the database level:

```javascript
match /events/{eventId} {
  allow read: if true; // Public read access

  allow create, update: if
    // Deny writes containing deprecated fields
    !request.resource.data.keys().hasAny([
      'brandColor', 'showTitleOverlay',
      'surveyEnabled', 'surveyRequired', 'surveyStepsCount', 'surveyStepsOrder', 'surveyVersion',
      'welcomeTitle', 'welcomeDescription', 'welcomeCtaLabel', 'welcomeBackgroundImagePath', 'welcomeBackgroundColorHex',
      'endHeadline', 'endBody', 'endCtaLabel', 'endCtaUrl',
      'shareAllowDownload', 'shareAllowSystemShare', 'shareAllowEmail', 'shareSocials'
    ]) &&
    // Ensure required fields are present
    request.resource.data.keys().hasAll(['id', 'title', 'status', 'share']) &&
    // Validate status enum
    request.resource.data.status in ['draft', 'live', 'archived'];
}
```

---

## Migration Notes

### Legacy Field Handling

**No automatic migration**: Existing events with legacy prefixed fields remain unchanged in Firestore.

**Read Strategy**:
- Event Designer components ignore legacy prefixed fields
- Only read from new nested objects (`event.welcome.*`, `event.ending.*`, etc.)
- If nested object is undefined, use default values (empty strings, default booleans)

**Write Strategy**:
- Server Actions write only to new nested objects
- Never read or write legacy prefixed fields
- Firestore security rules deny writes containing legacy field keys

**Coexistence**:
- Legacy and new fields can coexist in Firestore documents temporarily
- New nested fields take precedence in all application logic
- As creators edit events, legacy fields become orphaned but harmless

**Example Firestore Document (Mixed State)**:
```json
{
  "id": "abc123",
  "title": "TechCon 2025",
  "status": "live",

  // NEW nested structure (preferred)
  "welcome": {
    "title": "Welcome to TechCon!",
    "body": "Join us for amazing experiences"
  },

  // LEGACY flat fields (ignored by application)
  "welcomeTitle": "Old Welcome Title",
  "welcomeDescription": "Old description",

  // Application reads from "welcome.title", ignores "welcomeTitle"
}
```

---

## TypeScript Types

All TypeScript types are inferred from Zod schemas:

```typescript
export type Event = z.infer<typeof eventSchema>;
export type EventTheme = z.infer<typeof eventThemeSchema>;
export type EventWelcome = z.infer<typeof eventWelcomeSchema>;
export type EventEnding = z.infer<typeof eventEndingSchema>;
export type EventShareConfig = z.infer<typeof eventShareConfigSchema>;
export type ShareSocial = z.infer<typeof shareSocialSchema>;
export type EventStatus = z.infer<typeof eventStatusSchema>;
```

**Usage in Components**:
```typescript
// Optional chaining for nested objects
function WelcomeEditor({ event }: { event: Event }) {
  const title = event.welcome?.title ?? "";
  const body = event.welcome?.body ?? "";

  // TypeScript knows:
  // - event.welcome is EventWelcome | undefined
  // - event.welcome.title is string | undefined
}
```

---

## Summary

This refactored schema provides:

✅ **Semantic grouping**: Related fields organized into logical objects
✅ **Type safety**: Strict Zod schemas + TypeScript types
✅ **Validation layers**: Zod (Server Actions) + Firestore rules (database)
✅ **No migration risk**: Existing data untouched, natural migration via Event Designer
✅ **Developer experience**: Cleaner code, better autocomplete, fewer naming collisions
