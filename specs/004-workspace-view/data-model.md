# Data Model: Workspace View & Settings (Admin)

**Feature**: 004-workspace-view
**Date**: 2025-12-29
**Purpose**: Define data entities, schemas, and relationships for workspace view and settings

## Entity: Workspace (Existing - Extended)

### Description
Represents an organizational workspace with unique slug-based routing. Workspaces are the primary scoping mechanism for admin operations and projects.

### Schema

```typescript
interface Workspace {
  /** Unique workspace identifier (Firestore document ID) */
  id: string

  /** Human-readable workspace name (1-100 characters) */
  name: string

  /** URL-safe unique identifier (1-50 characters, lowercase, alphanumeric + hyphens) */
  slug: string

  /** Current lifecycle state (active | deleted) */
  status: WorkspaceStatus

  /** Unix timestamp (ms) when workspace was soft deleted (null if active) */
  deletedAt: number | null

  /** Unix timestamp (ms) when workspace was created */
  createdAt: number

  /** Unix timestamp (ms) of last modification */
  updatedAt: number
}

type WorkspaceStatus = 'active' | 'deleted'
```

### Field Constraints

| Field | Type | Required | Constraints | Validation |
|-------|------|----------|-------------|------------|
| `id` | string | Yes | Firestore document ID | Auto-generated by Firestore |
| `name` | string | Yes | 1-100 characters | `WORKSPACE_NAME.min` to `WORKSPACE_NAME.max` |
| `slug` | string | Yes | 1-50 chars, lowercase, alphanumeric + hyphens, no leading/trailing hyphens | `slugSchema` regex: `/^[a-z0-9][a-z0-9-]*[a-z0-9]$\|^[a-z0-9]$/` |
| `status` | WorkspaceStatus | Yes | Enum: 'active' \| 'deleted' | `workspaceStatusSchema` |
| `deletedAt` | number \| null | Yes | Unix timestamp (ms) or null | Must be null if `status === 'active'`, must be non-null if `status === 'deleted'` |
| `createdAt` | number | Yes | Unix timestamp (ms) | Auto-set on creation |
| `updatedAt` | number | Yes | Unix timestamp (ms) | Auto-updated on modification |

### Validation Rules

1. **Schema Invariant (Active)**: If `status === 'active'`, then `deletedAt === null`
2. **Schema Invariant (Deleted)**: If `status === 'deleted'`, then `deletedAt !== null`
3. **Slug Uniqueness**: `slug` must be globally unique across all workspaces (case-insensitive)
4. **Slug Immutability**: Deleted workspace slugs cannot be reused to avoid conflicts
5. **Name Duplication**: Multiple workspaces can have the same `name` (not unique)

### State Transitions

```
┌─────────────┐
│   active    │ ◄─── Initial state on creation
└──────┬──────┘
       │
       │ Soft delete (status = 'deleted', deletedAt = now())
       │
       ▼
┌─────────────┐
│  deleted    │ ◄─── Terminal state (no recovery in MVP)
└─────────────┘
```

**Allowed Transitions**:
- `active` → `deleted` (soft delete, out of scope for this feature)

**Forbidden Transitions**:
- `deleted` → `active` (no un-delete in MVP)

### Indexes

**Firestore Indexes Required**:

1. **Slug Lookup** (compound index):
   - Fields: `slug` (ASC), `status` (ASC)
   - Purpose: Fast workspace resolution by slug (only active workspaces)
   - Query: `where('slug', '==', slug).where('status', '==', 'active')`

2. **Admin List View** (single field index):
   - Fields: `status` (ASC), `createdAt` (DESC)
   - Purpose: List active workspaces sorted by creation date
   - Query: `where('status', '==', 'active').orderBy('createdAt', 'desc')`

### Firestore Path

```
/workspaces/{workspaceId}
```

---

## Input Schema: UpdateWorkspaceInput (New)

### Description
Input data for updating an existing workspace's name and/or slug.

### Schema

```typescript
interface UpdateWorkspaceInput {
  /** Workspace ID to update */
  id: string

  /** New workspace name (optional, 1-100 characters) */
  name?: string

  /** New workspace slug (optional, 1-50 characters, must be unique) */
  slug?: string
}
```

### Zod Validation Schema

```typescript
import { z } from 'zod'
import { WORKSPACE_NAME } from '../constants/workspace.constants'
import { slugSchema } from './workspace.schemas'

export const updateWorkspaceSchema = z
  .object({
    id: z.string().min(1, 'Workspace ID is required'),
    name: z
      .string()
      .min(WORKSPACE_NAME.min, 'Name is required')
      .max(
        WORKSPACE_NAME.max,
        `Name must be ${WORKSPACE_NAME.max} characters or less`
      )
      .optional(),
    slug: slugSchema.optional(),
  })
  .refine(
    (data) => data.name !== undefined || data.slug !== undefined,
    {
      message: 'At least one field (name or slug) must be provided',
      path: ['name'],
    }
  )

export type UpdateWorkspaceInput = z.infer<typeof updateWorkspaceSchema>
```

### Validation Rules

1. **At least one field**: Either `name` or `slug` (or both) must be provided
2. **Name constraints**: If provided, must satisfy `WORKSPACE_NAME` min/max constraints
3. **Slug constraints**: If provided, must satisfy `slugSchema` regex pattern
4. **Slug uniqueness**: If slug is provided, must be globally unique (checked server-side)

---

## Entity: WorkspaceStore (New - Client State)

### Description
Client-side Zustand store for managing workspace session persistence using localStorage.

### Schema

```typescript
interface WorkspaceStore {
  /** Last visited workspace slug (null if never visited) */
  lastVisitedWorkspaceSlug: string | null

  /** Update last visited workspace slug */
  setLastVisitedWorkspaceSlug: (slug: string) => void
}
```

### Persistence

- **Storage Key**: `workspace-storage` (localStorage)
- **Serialization**: Automatic via Zustand persist middleware
- **Rehydration**: Automatic on app load
- **Fallback**: Gracefully handles localStorage unavailable (state remains in-memory only)

### State Updates

```typescript
// Update last visited workspace (called after successful workspace resolution)
setLastVisitedWorkspaceSlug('acme-corp')

// Read last visited workspace (for redirects)
const { lastVisitedWorkspaceSlug } = useWorkspaceStore.getState()
```

---

## Derived Data

### Workspace Initials (Client-Side Computed)

**Purpose**: Generate 1-2 letter initials for display in workspace selector

**Algorithm**: Uses existing `getWorkspaceInitials` from `/domains/navigation/lib/`

```typescript
function getWorkspaceInitials(workspaceName: string | null | undefined): string {
  if (!workspaceName || workspaceName.trim() === '') return '?'

  const words = workspaceName.trim().split(/\s+/).filter(Boolean)

  if (words.length === 0) return '?'
  if (words.length === 1) return words[0][0].toUpperCase()

  return (words[0][0] + words[1][0]).toUpperCase()
}
```

**Examples**:
- `"Acme Corp"` → `"AC"` (2 words = 2 letters)
- `"Acme Inc"` → `"AI"` (2 words = 2 letters)
- `"Acme Corporation Inc"` → `"AC"` (3+ words = first 2 letters)
- `"Acme"` → `"A"` (1 word = 1 letter)
- `""` → `"?"`
- `null` → `"?"`

**Storage**: Not stored in database (computed on-demand)

**Location**: `/domains/navigation/lib/getWorkspaceInitials.ts` (already exists, needs update)

---

## Relationships

### Workspace → Projects (Future)

```
Workspace (1) ──── has many ──── (N) Projects
```

**Description**: Each workspace can contain multiple projects. Projects are scoped to a workspace and cannot exist without one.

**Implementation**: Out of scope for this feature (projects placeholder only)

---

## Access Control

### Admin-Only Access

**Firestore Security Rules**:
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check admin status
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Workspaces collection - admin-only access
    match /workspaces/{workspaceId} {
      // Allow admins to read all workspaces
      allow read: if isAdmin();

      // Deny direct writes - force through server functions for validation
      allow write: if false;
    }
  }
}
```

**Authorization Flow**:
1. Client reads workspace using Firebase client SDK
2. Firestore rules verify `request.auth.token.admin == true`
3. If not admin, request is rejected with permission denied error
4. All writes go through server functions that validate admin status + business rules

---

## Data Integrity Constraints

### Database-Level Constraints

1. **Slug Uniqueness**: Enforced via server-side transaction check before write
2. **Status-DeletedAt Consistency**: Enforced via Zod schema refinement
3. **Admin-Only Access**: Enforced via Firestore security rules
4. **Slug Reuse Prevention**: No mechanism to mark slugs as "reserved" - relies on `status === 'deleted'` check

### Application-Level Constraints

1. **Slug Normalization**: Always lowercase before storage (`slug.toLowerCase()`)
2. **Timestamp Consistency**: `updatedAt` must be set on every modification
3. **Atomic Updates**: Slug changes use Firestore transactions to prevent race conditions

---

## Migration Notes

### Existing Data

- Workspace entity schema already exists in codebase (`src/domains/workspace/schemas/workspace.schemas.ts`)
- No database migrations required
- New fields (`UpdateWorkspaceInput`) are additive, not breaking

### New Additions

1. `updateWorkspaceSchema` (Zod schema) - Added to `workspace.schemas.ts`
2. `UpdateWorkspaceInput` (TypeScript type) - Added to `workspace.types.ts`
3. `WorkspaceStore` (Zustand store) - New file `hooks/useWorkspaceStore.ts`

---

## Performance Considerations

### Query Optimization

- **Slug lookup**: Uses compound index (`slug` + `status`) for O(log n) lookup
- **Active workspaces**: Uses single field index (`status`) for fast filtering
- **Expected load**: <100ms query time for workspace resolution

### Caching Strategy

- **TanStack Query**: Cache workspace data for 5 minutes (stale-while-revalidate)
- **localStorage**: Persist `lastVisitedWorkspaceSlug` for instant redirects
- **Real-time updates**: Use `onSnapshot` for settings page to reflect changes immediately

---

## Error Scenarios

### Workspace Not Found

**Trigger**: Slug does not match any active workspace

**Response**:
```typescript
{
  workspace: null  // Handled by route's notFoundComponent
}
```

**UI**: Display `WorkspaceNotFound` component with friendly message and link to `/admin/workspaces`

### Slug Already in Use

**Trigger**: Attempt to update workspace slug to one already used by another active workspace

**Response**:
```typescript
throw new Error('Slug already in use')
```

**UI**: Display inline error on slug field: "Slug already in use"

### Permission Denied

**Trigger**: Non-admin user attempts to access workspace

**Response**:
```typescript
FirestoreError: permission-denied
```

**UI**: Display "You don't have access" error state

### localStorage Unavailable

**Trigger**: Browser blocks localStorage (private mode, user settings, security policy)

**Response**: Gracefully degrade - workspace navigation works, but session persistence is disabled

**UI**: No visible error - feature works without persistence

---

## Summary

### New Entities
- `UpdateWorkspaceInput` - Input schema for workspace updates
- `WorkspaceStore` - Zustand store for session persistence

### Modified Entities
- `Workspace` - No schema changes (existing entity)

### New Derived Data
- Workspace Icon (2-letter computed value)

### Key Constraints
- Slug uniqueness (global, case-insensitive)
- Admin-only access (Firestore rules)
- Status-deletedAt consistency (Zod refinement)

### Next Steps
Proceed to **API Contracts** to define server actions and client hooks.
