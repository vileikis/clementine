rules_version = '2';

// Firestore Security Rules for Clementine
// Auth System: Admin users have full access, non-admin rules to be defined later

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is admin
    function isAdmin() {
      return request.auth != null
        && request.auth.token.admin == true;
    }
    
    function isAuthenticated() {                                                                                                         
      return request.auth != null                                                                                                        
        && request.auth.token.firebase.sign_in_provider != 'anonymous';                                                                  
    }                                                                                                                                    

    function isAnyUser() {
      return request.auth != null;
    }

    // Workspace collection rules
    match /workspaces/{workspaceId} {
      // Admins have full access to workspaces
      allow read, create, update: if isAdmin();

      // Deny hard deletes - use server functions for soft delete
      allow delete: if false;

      // MediaAsset subcollection rules (013-event-settings-overlays)
      // Authentication-based access control - data validation in Zod schemas
      match /mediaAssets/{assetId} {
        // Authenticated users can read media assets
        allow read: if isAnyUser();

        // Only admins can create media assets
        allow create: if isAdmin();

        // Only admins can update (soft delete)
        allow update: if isAdmin();

        // No deletes - handled by Admin SDK scheduled jobs
        allow delete: if false;
      }

      // Experience subcollection rules (021-experience-data-library)
      // Workspace-scoped experiences with admin-only writes
      match /experiences/{experienceId} {
        // READ: Authenticated users can read experiences
        // Guests will read full document in E5+; client filters to published field
        allow read: if isAnyUser();

        // CREATE: Only admins can create experiences
        allow create: if isAdmin();

        // UPDATE: Only admins can update experiences
        allow update: if isAdmin();

        // DELETE: Forbid hard deletes - use soft delete (status='deleted')
        allow delete: if false;
      }

      // AI Presets subcollection rules (041-ai-presets-crud)
      // Workspace-scoped AI presets with admin-only writes
      match /aiPresets/{presetId} {
        // READ: Workspace members (authenticated users) can read presets
        allow read: if isAnyUser();

        // CREATE: Only admins can create presets
        allow create: if isAdmin();

        // UPDATE: Only admins can update presets (including soft delete)
        allow update: if isAdmin();

        // DELETE: Forbid hard deletes - use soft delete (status='deleted')
        allow delete: if false;
      }
    }

    // Projects collection rules
    match /projects/{projectId} {
      // Admins have full access to workspaces
      allow read, create, update: if isAdmin();

      // READ: Allow all authenticated users to read non-deleted projects
      allow read: if isAnyUser() && resource.data.status != 'deleted';

      // DELETE: Forbidden - use soft delete (status='deleted')
      allow delete: if false;

      // Project guests subcollection (037-guest-welcome)
      // Guests are anonymous or admin users visiting the project
      // Path: /projects/{projectId}/guests/{guestId}
      match /guests/{guestId} {
        // READ: Users can read their own guest record
        // Admins can read all guest records
        allow read: if isAdmin()
          || (isAnyUser() && guestId == request.auth.uid);

        // CREATE: Authenticated users (including anonymous) can create their own guest record
        // Guest ID must match the authenticated user's UID
        // authUid field must match the authenticated user's UID
        allow create: if isAnyUser()
          && guestId == request.auth.uid
          && request.resource.data.authUid == request.auth.uid
          && request.resource.data.projectId == projectId;

        // UPDATE: Users can update their own guest record
        // Only completedExperiences field can be modified (for pregate/preshare tracking)
        // Admins can update any guest record
        allow update: if isAdmin()
          || (isAnyUser()
              && guestId == request.auth.uid
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['completedExperiences']));

        // DELETE: Forbidden - guest records are historical
        allow delete: if false;
      }

      // Project sessions subcollection (030-session-runtime-capture)
      // Sessions track guest/admin execution of experiences
      // Path: /projects/{projectId}/sessions/{sessionId}
      match /sessions/{sessionId} {
        // READ: Admins can read all sessions
        // Authenticated users can read their own sessions
        allow read: if isAdmin()
          || (isAnyUser() && resource.data.createdBy == request.auth.uid);

        // CREATE: Authenticated users can create sessions
        // Session must reference valid project (projectId matches path)
        // Session createdBy must match the authenticated user's UID
        allow create: if isAnyUser()
          && request.resource.data.projectId == projectId
          && request.resource.data.createdBy == request.auth.uid;

        // UPDATE: Only session creator can update their session
        // Or admins can update any session
        allow update: if isAdmin()
          || (isAnyUser() && resource.data.createdBy == request.auth.uid);

        // DELETE: Forbidden - sessions are historical records
        allow delete: if false;
      }

      // Jobs subcollection (036-transform-foundation)
      // Transform pipeline job execution tracking
      // Path: /projects/{projectId}/jobs/{jobId}
      match /jobs/{jobId} {
        // READ: Admins only (jobs contain execution details for debugging)
        allow read: if isAdmin();

        // WRITE: Server only via Admin SDK (never client)
        // All job creation and updates happen in Cloud Functions
        allow create, update, delete: if false;
      }
    }

    // Admin users: Full access to everything
    // Non-admin users: Will be handled later (currently deny all writes, allow reads)
    match /{document=**} {
      allow read: if true; // Allow reads for now (will be restricted per collection later)
      allow write: if isAdmin(); // Only admins can write
    }
  }
}
